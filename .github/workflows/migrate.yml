name: Prisma Migrate (Supabase)

on:
  workflow_dispatch:
  push:
    paths:
      - "prisma/**"
      - "prisma.config.ts"
      - ".github/workflows/migrate.yml"
      - "package.json"
      - "package-lock.json"

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Prisma version (sanity check)
        run: ./node_modules/.bin/prisma --version
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Show DB host (safe)
        run: node -e "const u=new URL(process.env.DATABASE_URL); console.log('HOST='+u.host)"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Prisma generate
        run: ./node_modules/.bin/prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Prisma migrate deploy
        run: echo "Skipping migrate deploy (applied manually in Supabase SQL Editor)"
